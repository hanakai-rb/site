# frozen_string_literal: true

require "hanami/boot"

# Patch Parklife so it doesn't consider URLs ending with e.g. "v2.0" as having an extname
require "parklife/utils"
Parklife::Utils.class_eval do
  def build_path_for(path, index: true)
    path = path.gsub(/^\/|\/$/, "")

    # This `if` line is what we've modified. Previously it was:
    #
    # if File.extname(path).empty?
    if (extname = File.extname(path)) && (extname.match?(/\.\d+$/) || extname.empty?)
      if path.empty?
        "index.html"
      elsif index
        File.join(path, "index.html")
      else
        "#{path}.html"
      end
    else
      path
    end
  end
end

# Patch Parklife crawler to handle errors gracefully
require "parklife/crawler"

module AllowErrorAndRedirect
  def process_route(...)
    super
  rescue Parklife::HTTPError => e
    # Handle 500 errors and redirects by warning and continuing
    if e.message.include?("500 response") || e.message =~ /30[0-8] response/
      $stderr.puts "Warning: #{e.message} - skipping"
      false
    else
      raise
    end
  end
end

Parklife::Crawler.prepend AllowErrorAndRedirect

Parklife.application.configure do |config|
  config.app = Site::App

  # Generate e.g. /nested/route.html instead of /nested/route/index.html. This will see Netlify
  # ensure there are no trailing slashes on URLs, which is consistent with our routing when serving
  # the live Hanami app.
  config.nested_index = false

  # Allow the build to proceed after encountering a 404
  config.on_404 = :warn
end

Parklife.application.routes do
  root crawl: true

  # Add further paths not discovered by crawling from the root:
  #
  # get '/hidden/pages', crawl: true
  # get '/feed.atom'

  # Services typically allow a custom 404 page.
  # get '/404.html'
end

# Build search index after Parkfile is loaded
# This will run during the build process
at_exit do
  if $!.nil? || $!.is_a?(SystemExit) && $!.success?
    # Only build search index if parklife build was successful
    if defined?(Parklife) && ARGV.include?("build")
      puts "\n==> Building search index..."
      require "rake"
      require "fileutils"
      load File.expand_path("Rakefile", __dir__)
      Rake::Task["search:build_index"].invoke

      # Copy search files to build directory
      puts "Copying search index files to build directory..."

      # Copy versioned search files (with checksum in filename)
      Dir.glob("public/lunr-index.*.json").each { |f| FileUtils.cp(f, "build/#{File.basename(f)}") }
      Dir.glob("public/search-documents.*.json").each { |f| FileUtils.cp(f, "build/#{File.basename(f)}") }

      puts "âœ“ Search files copied to build/"
    end
  end
end
